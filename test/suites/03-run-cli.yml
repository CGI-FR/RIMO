name: run rimo
testcases:
  # rimo analyse sur un seul fichier
  - name: on a single table
    steps:
      - script: mkdir data
      - script: |-
          cat > data/user.jsonl <<EOF
          {"address": "PSC 4713, Box 9649 APO AA 43433", "age": 29, "date": "2013-06-11", "phone": "001-958-985-3039"}
          {"address": "095 Jennifer Turnpike Castrobury, NY 98111", "age": 35, "date": "2014-07-24", "phone": "(517)819-3454"}
          {"address": "06210 David Court South Kimberly, IL 10236", "age": 61, "date": "2003-10-11", "phone": "001-866-271-0116"}
          {"address": "2035 Simmons Islands Heatherchester, IN 46152", "age": 73, "date": "2005-05-10", "phone": "+1-407-997-8293x68130"}
          {"address": "275 Stone Ridges Suite 885 East Aliciafurt, MH 15407", "age": 47, "date": "2022-04-23", "phone": "828-755-3826"}
          {"address": "38432 Moreno Turnpike Garrettland, TN 72939", "age": 95, "date": "2001-08-23", "phone": "7795418893"}
          {"address": "25545 Cole Court Newtonfurt, KY 13882", "age": 47, "date": "2004-07-04", "phone": "(330)616-7639x7810"}
          {"address": "0301 Amy Grove Apt. 325 Janefort, MA 84102", "age": 65, "date": "2014-09-09", "phone": "260-587-0590"}
          {"address": "536 Robinson Estates Austinside, NV 69535", "age": 45, "date": "2011-07-13", "phone": "001-845-854-2110"}
          {"address": "9038 Frye Ramp South Cheryltown, CT 54262", "age": 80, "date": "2010-11-18", "phone": "001-533-758-7269"}
          EOF
      - script: |-
          cat > expected.yaml <<EOF
          database: "data"
          tables:
          - name: "user"
            columns:
            - name: "address"
              type: "string"
              concept: ""
              constraint: []
              confidential: null
              sample:
              - "PSC 4713, Box 9649 APO AA 43433"
              - "095 Jennifer Turnpike Castrobury, NY 98111"
              - "06210 David Court South Kimberly, IL 10236"
              - "2035 Simmons Islands Heatherchester, IN 46152"
              - "275 Stone Ridges Suite 885 East Aliciafurt, MH 15407"
              statistics:
                count: 10
                unique: 10
                length_histogram:
                  min_length: 31
                  max_length: 52
                  25%_length: 41
                  50%_length: 42
                  75%_length: 43
                most_freq_len:
                  42: 0.3
                  41: 0.2
                least_frequent_len:
                  31: 0.1
                  45: 0.1
                  52: 0.1
                  43: 0.1
                  37: 0.1
                least_frequent_values:
                - "PSC 4713, Box 9649 APO AA 43433"
                - "2035 Simmons Islands Heatherchester, IN 46152"
                - "275 Stone Ridges Suite 885 East Aliciafurt, MH 15407"
                - "38432 Moreno Turnpike Garrettland, TN 72939"
                - "5545 Cole Court Newtonfurt, KY 13882 "
            - name: "age"
              type: "integer"
              concept: ""
              constraint: []
              confidential: null
              sample:
              - 29
              - 35
              - 61
              - 73
              - 47
              statistics:
                count: 10
                unique: 9
                mean: 57.7
                value_histogram:
                  min: 29.0
                  25%: 45.0
                  50%: 54.0
                  75%: 73.0
                  max: 95.0
            - name: "date"
              type: "string"
              concept: ''
              constraint: []
              confidential: null
              sample:
              - "2013-06-11 00:00:00"
              - "2014-07-24 00:00:00"
              - "2003-10-11 00:00:00"
              - "2005-05-10 00:00:00"
              - "2022-04-23 00:00:00"
              statistics:
                count: 10
                unique: 10
                length_histogram:
                  min_date: "2001-08-23 00:00:00"
                  max_date: "2022-04-23 00:00:00"
            - name: phone
              type: "string"
              concept: ""
              constraint: []
              confidential: null
              sample:
              - "001-958-985-3039"
              - "(517)819-3454"
              - "001-866-271-0116"
              - "+1-407-997-8293x68130"
              - "828-755-3826"
              statistics:
                count: 10
                unique: 10
                length_histogram:
                  min_length: 10
                  max_length: 21
                  25%_length: 12
                  50%_length: 16
                  75%_length: 16
                most_freq_len:
                  16: 0.4
                  12: 0.2
                least_frequent_len:
                  13: 0.1
                  21: 0.1
                  10: 0.1
                  18: 0.1
                least_frequent_values:
                - "(517)819-3454"
                - "+1-407-997-8293x68130"
                - "7795418893"
                - "(330)616-7639x7810"
        EOF
      - script: |-
          rimo analyse data
      - script: diff expected.yaml data/rimo.yaml
        assertions:
          - result.code ShouldEqual 0
          - result.systemout ShouldBeEmpty
      - script: rm -rf data

    # rimo analyse sur un dossier complet
    - name: on multiple tables
    steps:
      - script: mkdir petclinic
      - script: |-
          cat > petclinic/owner.jsonl <<EOF
          {"id": 1, "lastname": "Martin", "firstname": "Nicolas"}
          {"id": 2, "lastname": "Dupont", "firstname": "Louise"}
          {"id": 3, "lastname": "Laurent", "firstname": "Coline"}
          {"id": 4, "lastname": "Durand", "firstname": "Léa"}
          {"id": 5, "lastname": "Bernard", "firstname": "Dominique"}
          EOF
      - script: |-
          cat > petclinic/pet.jsonl <<EOF
          {"id": "CHA01", "name": "Uno", "age": 15, "type": "chat"}
          {"id": "CHI01", "name": "Nala", "age": 2, "type": "chien"}
          {"id": "CHI02", "name": "Pumba", "age": 8, "type": "chien"}
          {"id": "OIS01", "name": "Loco", "age": 2, "type": "oiseau"}
          {"id": "CHI03", "name": "Titi", "age": 8, "type": "chien"}
          EOF
      - script: |-
          cat > petclinic/visit.jsonl <<EOF
          {"owner_id": 1, "pet_id": "CHI02", "last_visit": "2023-07-10", "total_visit": 10}
          {"owner_id": 2, "pet_id": "CHA01", "last_visit": "2022-01-21", "total_visit": 2}
          {"owner_id": 3, "pet_id": "CHI03", "last_visit": "2023-04-07", "total_visit": 5}
          {"owner_id": 4, "pet_id": "CHI01", "last_visit": "2018-04-28", "total_visit": 1}
          {"owner_id": 5, "pet_id": "OIS01", "last_visit": "2023-01-15", "total_visit": 2}
          EOF
      - script: |-
          cat > expected.yaml <<EOF
          database: "petclinic"
          tables:
          - name: "owner"
            columns:
            - name: "id"
              type: "integer"
              concept: ""
              constraint: []
              confidential: null
              sample:
              - 1
              - 2
              - 3
              - 4
              - 5
              statistics:
                count: 5
                unique: 5
                mean: 3
                value_histogram:
                  min: 1.0
                  25%: 1.5
                  50%: 3.0
                  75%: 4.5
                  max: 5
            - name: "lastname"
              type: "string"
              concept: ""
              constraint: []
              confidential: null
              sample:
              - "Martin"
              - "Dupont"
              - "Laurent"
              - "Durand"
              - "Bernard"
              statistics:
                count: 5
                unique: 5
                length_histogram:
                  min_length: 6
                  max_length: 7
                  25%_length: 6
                  50%_length: 6
                  75%_length: 7
                most_freq_len:
                  6: 0.6
                least_frequent_len:
                  7: 0.4
                least_frequent_values:
                - "Laurent"
                - "Bernard"
          - name: "firstname"
              type: "string"
              concept: ""
              constraint: []
              confidential: null
              sample:
              - "Nicolas"
              - "Louise"
              - "Coline"
              - "Léa"
              - "Dominique"
              statistics:
                count: 5
                unique: 5
                length_histogram:
                  min_length: 3.0
                  max_length: 9.0
                  25%_length: 4.5
                  50%_length: 6.0
                  75%_length: 8.0
                most_freq_len:
                  6: 0.4
                least_frequent_len:
                  7: 0.2
                  3: 0.2
                  9: 0.2
                least_frequent_values:
                - "Nicolas"
                - "Léa"
                - "Dominique"
          - name: "pets"
            columns:
            - name: "id"
              type: "string"
              concept: ""
              constraint: []
              confidential: null
              sample:
              - "CHA01"
              - "CHI01"
              - "CHI02"
              - "OIS01"
              - "CHI03"
              statistics:
                count: 5
                unique: 5
                length_histogram:
                  min_length: 5
                  max_length: 5
                  25%_length: 5
                  50%_length: 5
                  75%_length: 5
                most_freq_len:
                  5: 1
                least_frequent_len:
                least_frequent_values:
          - name: "name"
              type: "string"
              concept: ""
              constraint: []
              confidential: null
              sample:
              - "Uno"
              - "Nala"
              - "Pumba"
              - "Loco"
              - "Titi"
              statistics:
                count: 5
                unique: 5
                length_histogram:
                  min_length: 3.0
                  max_length: 5.0
                  25%_length: 3.5
                  50%_length: 4.0
                  75%_length: 4.5
                most_freq_len:
                  4: 0.6
                least_frequent_len:
                  3: 0.2
                  5: 0.2
                least_frequent_values:
                - "Uno"
                - "Pumba"
          - name: "age"
              type: "integer"
              concept: ""
              constraint: []
              confidential: null
              sample:
              - 15
              - 2
              - 8
              - 2
              - 8
              statistics:
                count: 5
                unique: 3
                mean: 7.0
                value_histogram:
                  min: 2.0
                  25%: 2.0
                  50%: 8.0
                  75%: 11.5
                  max: 15.0
          - name: "type"
              type: "string"
              concept: ""
              constraint: []
              confidential: null
              sample:
              - "chat"
              - "chien"
              - "chien"
              - "oiseau"
              - "chien"
              statistics:
                count: 5
                unique: 3
                length_histogram:
                  min_length: 4.0
                  max_length: 6.0
                  25%_length: 4.5
                  50%_length: 5.0
                  75%_length: 5.5
                most_freq_len:
                  5: 0.6
                least_frequent_len:
                  4: 0.2
                  6: 0.2
                least_frequent_values:
                - "chat"
                - "oiseau"
          - name: "visit"
            columns:
            - name: "owner_id"
              type: "integer"
              concept: ""
              constraint: []
              confidential: null
              sample:
              - 1
              - 2
              - 3
              - 4
              - 5
              statistics:
                count: 5
                unique: 5
                mean: 3
                value_histogram:
                  min: 1.0
                  25%: 1.5
                  50%: 3.0
                  75%: 4.5
                  max: 5
          - name: "pet_id"
              type: "string"
              concept: ""
              constraint: []
              confidential: null
              sample:
              - "CHI02"
              - "CHA01"
              - "CHI03"
              - "CHI01"
              - "OIS01"
              statistics:
                count: 5
                unique: 5
                length_histogram:
                  min_length: 5
                  max_length: 5
                  25%_length: 5
                  50%_length: 5
                  75%_length: 5
                most_freq_len:
                  5: 1
                least_frequent_len:
                least_frequent_values:
          - name: "last_visit"
              type: "string"
              concept: ''
              constraint: []
              confidential: null
              sample:
              - "2023-07-10 00:00:00"
              - "2022-01-21 00:00:00"
              - "2023-04-07 00:00:00"
              - "2018-04-28 00:00:00"
              - "2023-01-15 00:00:00"
              statistics:
                count: 5
                unique: 5
                length_histogram:
                  min_date: "2018-04-28 00:00:00"
                  max_date: "2023-07-10 00:00:00"
          - name: "total_visit"
              type: "integer"
              concept: ""
              constraint: []
              confidential: null
              sample:
              - 10
              - 2
              - 5
              - 1
              - 2
              statistics:
                count: 5
                unique: 5
                mean: 3
                value_histogram:
                  min: 1.0
                  25%: 1.5
                  50%: 2.0
                  75%: 7.5
                  max: 10
        EOF
      - script: |-
          rimo analyse petclinic
      - script: diff expected.yaml petclinic/rimo.yaml
        assertions:
          - result.code ShouldEqual 0
          - result.systemout ShouldBeEmpty
      - script: rm -rf petclinic
